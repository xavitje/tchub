// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============================================
// USER MANAGEMENT
// ============================================

model User {
  id              String    @id @default(cuid())
  azureAdId       String?   @unique
  email           String    @unique
  displayName     String
  firstName       String?
  lastName        String?
  department      String?
  jobTitle        String?
  profileImage    String?
  role            String    @default("EMPLOYEE") // Legacy: remove after migration
  roleId          String?
  customRole      Role?     @relation(fields: [roleId], references: [id])
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  posts           Post[]    @relation("UserPosts")
  pinnedPosts     Post[]    @relation("PinnedPosts")
  comments        Comment[]
  favorites       Favorite[]
  pollVotes       PollVote[]
  eventRegistrations EventRegistration[]
  notifications   Notification[]
  likes           PostLike[]
  trainingProgress UserTrainingProgress[]

  // Settings & Chat
  settings        UserSettings?
  quickLinks      QuickLink[]      @relation("QuickLinks")
  conversations   Conversation[] 
  messages        Message[]

  // Chat Extras
  chatSettings    ConversationSettings[]
  messageReads    MessageRead[]
  typingIndicators TypingIndicator[]
}

model Role {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  permissions   Permission[]
  users         User[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Permission {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  roles       Role[]   
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ============================================
// USER SETTINGS
// ============================================

model UserSettings {
  id              String    @id @default(cuid())
  userId          String    @unique
  theme           String    @default("SYSTEM")
  headerOrder     String    @default("home,discussions,training,hubs,support")
  emailNotifications Boolean  @default(true)
  pushNotifications  Boolean  @default(true)

  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model QuickLink {
  id              String    @id @default(cuid())
  userId          String
  title           String
  url             String
  icon            String?
  order           Int       @default(0)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  user            User      @relation("QuickLinks", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, order])
}

// ============================================
// CHAT & MESSAGING
// ============================================

model Conversation {
  id              String    @id @default(cuid())
  name            String?   // For group chats
  isGroup         Boolean   @default(false)
  image           String?   // For group chats
  lastMessageAt   DateTime  @default(now())
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  users           User[]    

  messages        Message[]

  // Extras
  settings        ConversationSettings[]

  @@index([lastMessageAt])
}

model Message {
  id              String    @id @default(cuid())
  conversationId  String
  senderId        String
  content         String?
  image           String?
  fileUrl         String?
  fileName        String?
  isEdited        Boolean   @default(false)
  editedAt        DateTime?
  deletedAt       DateTime? // Soft delete

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender          User         @relation(fields: [senderId], references: [id])
  reactions       Reaction[]
  reads           MessageRead[]

  replyToId      String?  
  replyTo        Message? @relation("ReplyTo", fields: [replyToId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  replies        Message[] @relation("ReplyTo")

  @@index([conversationId, createdAt])
}

model Reaction {
  id              String    @id @default(cuid())
  messageId       String
  userId          String
  emoji           String

  message         Message   @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId, emoji])
}

model ConversationSettings {
  id              String   @id @default(cuid())
  conversationId  String
  userId          String
  isMuted         Boolean  @default(false)
  mutedUntil      DateTime?

  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
}

model TypingIndicator {
  id              String   @id @default(cuid())
  conversationId  String
  userId          String
  lastTypingAt    DateTime @default(now())

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
  @@index([conversationId, lastTypingAt])
}

model MessageRead {
  id         String   @id @default(cuid())
  messageId  String
  userId     String
  readAt     DateTime @default(now())

  message    Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId])
}


// ============================================
// POSTS & CONTENT
// ============================================

model Post {
  id              String      @id @default(cuid())
  type            String      // POST, POLL, EVENT, ANNOUNCEMENT
  title           String
  content         String
  imageUrl        String?
  authorId        String      
  isPinned        Boolean     @default(false)
  pinnedAt        DateTime?
  pinnedById      String?     
  viewCount       Int         @default(0)
  likeCount       Int         @default(0)
  commentCount    Int         @default(0)
  isPublished     Boolean     @default(true)
  publishedAt     DateTime?

  // Announcement-specific fields
  announcementType String? @default("REGULAR") // REGULAR, SHAREPOINT_LINK
  sharePointUrl     String?

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  // Relations
  author          User        @relation("UserPosts", fields: [authorId], references: [id])
  pinnedBy        User?       @relation("PinnedPosts", fields: [pinnedById], references: [id])
  comments        Comment[]
  tags            Tag[]       
  favorites       Favorite[]
  likes           PostLike[]
  attachments     Attachment[]

  // Type-specific data
  poll            Poll?
  event           Event?

  @@index([type, createdAt])
  @@index([isPinned, createdAt])
  @@index([authorId])
}

// ============================================
// POLLS
// ============================================

model Poll {
  id              String      @id @default(cuid())
  postId          String      @unique 
  endsAt          DateTime?
  allowMultiple   Boolean     @default(false)
  isAnonymous     Boolean     @default(false)

  post            Post        @relation(fields: [postId], references: [id], onDelete: Cascade)
  options         PollOption[]
  votes           PollVote[]
}

model PollOption {
  id              String      @id @default(cuid())
  pollId          String      
  text            String
  order           Int
  voteCount       Int         @default(0)

  poll            Poll        @relation(fields: [pollId], references: [id], onDelete: Cascade)
  votes           PollVote[]

  @@index([pollId])
}

model PollVote {
  id              String      @id @default(cuid())
  pollId          String      
  optionId        String      
  userId          String      
  createdAt       DateTime    @default(now())

  poll            Poll        @relation(fields: [pollId], references: [id], onDelete: Cascade)
  option          PollOption  @relation(fields: [optionId], references: [id], onDelete: Cascade)
  user            User        @relation(fields: [userId], references: [id])

  @@unique([pollId, userId, optionId])
  @@index([userId])
}

// ============================================
// EVENTS
// ============================================

model Event {
  id              String      @id @default(cuid())
  postId          String      @unique 
  startDate       DateTime
  endDate         DateTime?
  location        String?
  isVirtual       Boolean     @default(false)
  meetingLink     String?
  maxAttendees    Int?
  registrationDeadline DateTime?

  post            Post        @relation(fields: [postId], references: [id], onDelete: Cascade)
  registrations   EventRegistration[]
}

model EventRegistration {
  id              String      @id @default(cuid())
  eventId         String      
  userId          String      
  status          String      @default("REGISTERED") // REGISTERED, WAITLIST, CANCELLED
  syncedToOutlook Boolean     @default(false)
  createdAt       DateTime    @default(now())

  event           Event       @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user            User        @relation(fields: [userId], references: [id])

  @@unique([eventId, userId])
  @@index([userId])
}

// ============================================
// COMMENTS
// ============================================

model Comment {
  id              String      @id @default(cuid())
  postId          String      
  authorId        String      
  content         String
  parentId        String?     
  likeCount       Int         @default(0)
  isEdited        Boolean     @default(false)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  post            Post        @relation(fields: [postId], references: [id], onDelete: Cascade)
  author          User        @relation(fields: [authorId], references: [id])
  parent          Comment?    @relation("CommentReplies", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  replies         Comment[]   @relation("CommentReplies")

  @@index([postId, createdAt])
  @@index([authorId])
}

// ============================================
// FAVORITES
// ============================================

model Favorite {
  id              String      @id @default(cuid())
  userId          String      
  postId          String?     
  hubId           String?     
  type            String      // POST, HUB_PAGE
  createdAt       DateTime    @default(now())

  user            User        @relation(fields: [userId], references: [id])
  post            Post?       @relation(fields: [postId], references: [id], onDelete: Cascade)
  hub             Hub?        @relation(fields: [hubId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@unique([userId, hubId])
  @@index([userId])
}

// ============================================
// TC HUBS
// ============================================

model Hub {
  id              String      @id @default(cuid())
  name            String
  slug            String      @unique
  description     String?
  icon            String?
  sharePointUrl   String?
  order           Int
  isActive        Boolean     @default(true)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  favorites       Favorite[]

  @@index([order])
}

// ============================================
// NOTIFICATIONS
// ============================================

model Notification {
  id              String      @id @default(cuid())
  userId          String      
  type            String      // NEW_POST, NEW_COMMENT, etc.
  title           String
  message         String
  link            String?
  isRead          Boolean     @default(false)
  createdAt       DateTime    @default(now())

  user            User        @relation(fields: [userId], references: [id])

  @@index([userId, isRead, createdAt])
}

// ============================================
// TAGS & ATTACHMENTS
// ============================================

model Tag {
  id              String      @id @default(cuid())
  name            String      @unique
  slug            String      @unique
  color           String?

  posts           Post[]      
}

model Attachment {
  id              String      @id @default(cuid())
  postId          String      
  fileName        String
  fileUrl         String
  fileType        String
  fileSize        Int
  createdAt       DateTime    @default(now())

  post            Post        @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId])
}

model PostLike {
  id        String   @id @default(cuid())
  postId    String   
  userId    String   
  createdAt DateTime @default(now())

  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])
  @@index([userId])
}

// ============================================
// TRAINING & COURSES
// ============================================

model TrainingCourse {
  id            String    @id @default(cuid())
  title         String
  description   String
  imageUrl      String?
  level         String    @default("BEGINNER") // BEGINNER, INTERMEDIATE, ADVANCED
  duration      String?   // e.g. "2 uur"
  category      String    @default("GENERAL") // GENERAL, SALES, MARKETING, PRODUCT
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  modules       TrainingModule[]
  progress      UserTrainingProgress[]
}

model TrainingModule {
  id            String    @id @default(cuid())
  courseId      String
  title         String
  description   String?
  order         Int       @default(0)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  course        TrainingCourse @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessons       TrainingLesson[]

  @@index([courseId, order])
}

model TrainingLesson {
  id            String    @id @default(cuid())
  moduleId      String
  title         String
  content       String?   // Rich text content
  videoUrl      String?
  order         Int       @default(0)
  duration      Int?      // Minutes
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  module        TrainingModule @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  progress      UserTrainingProgress[]

  @@index([moduleId, order])
}

model UserTrainingProgress {
  id            String    @id @default(cuid())
  userId        String
  courseId      String
  lessonId      String
  status        String    @default("IN_PROGRESS") // IN_PROGRESS, COMPLETED
  lastAccessed  DateTime  @default(now())
  completedAt   DateTime?

  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  course        TrainingCourse @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lesson        TrainingLesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
  @@index([userId, courseId])
}
